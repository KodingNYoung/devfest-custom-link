name: Deploy to Eusate VM
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: SSH into VM and deploy
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          ENV_FILE: ${{ secrets.ENV_PROD }}
        run: |
          echo "Deploying branch: $BRANCH_NAME"
          ENV_FILE_B64=$(echo "$ENV_FILE" | base64 -w 0)
          sshpass -p "${{ secrets.SSH_PASSWORD_PROD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME_PROD }}@91.107.141.22 << EOF
            set -e
            cd /home/eusate/eusate-fe
            GIT_SSH_COMMAND="ssh -i /root/.ssh/id_rsa2" git fetch origin $BRANCH_NAME
            GIT_SSH_COMMAND="ssh -i /root/.ssh/id_rsa2" git checkout $BRANCH_NAME
            GIT_SSH_COMMAND="ssh -i /root/.ssh/id_rsa2" git pull origin $BRANCH_NAME
            echo "$ENV_FILE_B64" | base64 -d > .env
            docker compose -f production.docker-compose.yml build 
            docker compose -f production.docker-compose.yml up -d
            docker images -f "dangling=true" -q | xargs -r docker rmi
          EOF
